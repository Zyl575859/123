name: 构建Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-11-jdk python3-pip build-essential autoconf automake libtool libtool-bin pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev python3-dev
        
    - name: 安装Buildozer和所有依赖
      run: |
        pip3 install --user buildozer cython wheel setuptools
        pip3 install --user python-for-android
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: 初始化Android SDK环境
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $ANDROID_HOME/licenses
        
    - name: 手动安装Android SDK Command-line Tools
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $ANDROID_HOME/cmdline-tools
        cd /tmp
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip || wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-*.zip -d $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest || true
        mkdir -p $ANDROID_HOME/tools/bin
        if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
          ln -sf $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager $ANDROID_HOME/tools/bin/sdkmanager || true
        fi
        
    - name: 接受Android SDK许可证
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
        mkdir -p $ANDROID_HOME/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
        if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        fi
        
    - name: 清理环境变量冲突
      run: |
        echo "清理可能冲突的环境变量..."
        unset ANDROID_NDK_HOME || true
        unset ANDROID_NDK_ROOT || true
        unset ANDROID_NDK_LATEST_HOME || true
        echo "环境变量已清理"
        
    - name: 预检查构建环境
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export ANDROID_NDK=$HOME/.buildozer/android/platform/android-ndk-r25b
        export PATH=$PATH:$ANDROID_HOME/tools/bin:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin
        
        echo "=========================================="
        echo "预检查构建环境"
        echo "=========================================="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_NDK: $ANDROID_NDK"
        echo ""
        echo "检查 buildozer:"
        which buildozer || echo "❌ buildozer 未找到"
        buildozer --version || echo "❌ buildozer 版本检查失败"
        echo ""
        echo "检查 Python:"
        python3 --version
        which python3
        echo ""
        echo "检查编译工具:"
        gcc --version | head -1 || echo "❌ gcc 未找到"
        g++ --version | head -1 || echo "❌ g++ 未找到"
        make --version | head -1 || echo "❌ make 未找到"
        echo ""
        echo "检查 Android SDK:"
        if [ -d "$ANDROID_HOME" ]; then
          echo "✅ ANDROID_HOME 目录存在"
          ls -la "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" 2>/dev/null && echo "✅ sdkmanager 存在" || echo "❌ sdkmanager 不存在"
        else
          echo "❌ ANDROID_HOME 目录不存在"
        fi
        echo ""
        echo "检查 Python 依赖:"
        python3 -c "import buildozer; print('✅ buildozer 模块可用')" || echo "❌ buildozer 模块不可用"
        python3 -c "import cython; print('✅ cython 模块可用')" || echo "❌ cython 模块不可用"
        echo "=========================================="
        
    - name: 诊断路径和依赖
      run: |
        # 设置环境变量
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export ANDROID_NDK=$HOME/.buildozer/android/platform/android-ndk-r25b
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/tools/bin:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin
        export PYTHONPATH=$HOME/.local/lib/python3.10/site-packages:$PYTHONPATH
        
        echo "=========================================="
        echo "诊断路径和依赖"
        echo "=========================================="
        echo ""
        echo "1. 检查工作目录："
        pwd
        ls -la
        echo ""
        echo "2. 检查 buildozer.spec："
        if [ -f "buildozer.spec" ]; then
          echo "✅ buildozer.spec 存在"
          cat buildozer.spec
        else
          echo "❌ buildozer.spec 不存在"
        fi
        echo ""
        echo "3. 检查 Python 模块："
        python3 -c "import pythonforandroid; print('✅ pythonforandroid 模块可用'); print('路径:', pythonforandroid.__file__)" || echo "❌ pythonforandroid 模块不可用"
        python3 -c "from pythonforandroid.toolchain import ToolchainCL; print('✅ ToolchainCL 可导入')" || echo "❌ ToolchainCL 导入失败"
        echo ""
        echo "4. 检查路径："
        echo "  ANDROID_HOME=$ANDROID_HOME"
        echo "  ANDROID_NDK=$ANDROID_NDK"
        echo "  工作目录=$(pwd)"
        echo "  .buildozer 目录:"
        ls -la .buildozer 2>/dev/null || echo "  .buildozer 目录不存在"
        echo ""
        echo "5. 尝试直接运行 pythonforandroid 命令（测试）："
        python3 -m pythonforandroid.toolchain --help 2>&1 | head -20 || echo "命令执行失败"
        echo "=========================================="
        
    - name: 构建APK
      run: |
        # 清理可能冲突的环境变量
        unset ANDROID_NDK_HOME || true
        unset ANDROID_NDK_ROOT || true
        unset ANDROID_NDK_LATEST_HOME || true
        
        # 设置正确的环境变量
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export ANDROID_NDK=$HOME/.buildozer/android/platform/android-ndk-r25b
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/tools/bin:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin
        export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/lib/pkgconfig
        
        # 确保 Python 可以找到所有模块
        export PYTHONPATH=$HOME/.local/lib/python3.10/site-packages:$PYTHONPATH
        
        # 抑制 Autotools 警告（已弃用的宏警告不会导致构建失败）
        export AUTOTOOLS_WARNINGS=ignore
        export WARN_CFLAGS="-Wno-error"
        
        # 确保工作目录正确
        cd $GITHUB_WORKSPACE
        echo "当前工作目录: $(pwd)"
        
        echo "=========================================="
        echo "开始构建 APK..."
        echo "=========================================="
        echo "环境变量:"
        echo "  ANDROID_HOME=$ANDROID_HOME"
        echo "  ANDROID_NDK=$ANDROID_NDK"
        echo "  ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
        echo "  PATH=$PATH"
        echo "  PYTHONPATH=$PYTHONPATH"
        echo "  工作目录=$(pwd)"
        echo "=========================================="
        echo ""
        
        # 运行构建，保存完整日志，使用详细模式
        set -o pipefail
        buildozer -v android debug 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        
        echo ""
        echo "=========================================="
        echo "构建完成，退出代码: $BUILD_EXIT_CODE"
        echo "=========================================="
        
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo ""
          echo "=========================================="
          echo "构建失败！详细错误分析..."
          echo "=========================================="
          echo ""
          
          # 查找 pythonforandroid.toolchain create 命令的位置
          TOOLCHAIN_LINE=$(grep -n "pythonforandroid.toolchain create" build.log | tail -1 | cut -d: -f1)
          if [ -n "$TOOLCHAIN_LINE" ]; then
            echo "找到 pythonforandroid.toolchain create 命令在第 $TOOLCHAIN_LINE 行"
            echo "显示该命令前后的 100 行上下文："
            echo ""
            START_LINE=$((TOOLCHAIN_LINE - 50))
            if [ $START_LINE -lt 1 ]; then
              START_LINE=1
            fi
            END_LINE=$((TOOLCHAIN_LINE + 100))
            sed -n "${START_LINE},${END_LINE}p" build.log
            echo ""
            echo "=========================================="
            echo ""
          fi
          
          echo "1. 查找所有错误关键词（排除 Autotools 警告，最后 100 行）："
          grep -i "error\|failed\|失败\|错误\|exception\|traceback" build.log | grep -v "警告\|warning\|已过时\|deprecated\|autoupdate" | tail -100 || true
          echo ""
          echo "2. 查找 pythonforandroid 相关错误（最后 50 行）："
          grep -i "pythonforandroid\|toolchain\|p4a" build.log | tail -50 || true
          echo ""
          echo "3. 查找命令失败信息："
          grep -i "命令失败\|command failed\|无法执行\|cannot execute" build.log | tail -30 || true
          echo ""
          echo "4. 查找编译错误："
          grep -i "gcc\|g++\|clang\|compile\|compilation" build.log | tail -30 || true
          echo ""
          echo "5. 查找导入错误："
          grep -i "import\|module\|no module\|importerror\|modulenotfound" build.log | tail -30 || true
          echo ""
          echo "6. 查找内存错误："
          grep -i "killed\|memory\|oom\|out of memory" build.log | tail -20 || true
          echo ""
          echo "7. 查找 Traceback 和异常信息："
          grep -A 20 -i "traceback\|exception\|traceback" build.log | tail -50 || true
          echo ""
          echo "8. 查找路径相关错误："
          grep -i "path\|路径\|directory\|目录\|not found\|不存在" build.log | tail -30 || true
          echo ""
          echo "9. 查找 storage-dir 相关错误："
          grep -i "storage-dir\|storage_dir\|storage dir" build.log | tail -20 || true
          echo ""
          echo "10. 查找 Autotools 相关错误（非警告）："
          grep -i "autoreconf.*错误\|autoconf.*错误\|configure.*错误\|autotools.*错误" build.log | grep -v "警告\|warning" | tail -20 || true
          echo ""
          echo "11. 构建日志最后 300 行（完整上下文）："
          tail -300 build.log
          echo ""
          echo "=========================================="
          echo "请查看上面的错误信息以诊断问题"
          echo "=========================================="
          
          # 保存完整日志作为 artifact
          echo "保存完整构建日志..."
          mkdir -p logs
          cp build.log logs/build.log || true
          
          # 也保存错误摘要
          echo "保存错误摘要..."
          {
            echo "=== 错误摘要 ==="
            echo "构建退出代码: $BUILD_EXIT_CODE"
            echo ""
            echo "=== 所有错误关键词 ==="
            grep -i "error\|failed\|失败\|错误" build.log | tail -100
            echo ""
            echo "=== pythonforandroid 相关错误 ==="
            grep -i "pythonforandroid\|toolchain\|p4a" build.log | tail -50
            echo ""
            echo "=== 最后 300 行日志 ==="
            tail -300 build.log
          } > logs/error_summary.txt || true
          
          exit 1
        fi
        
        echo "✅ 构建成功完成！"
        
    - name: 查找APK文件
      run: |
        echo "=========================================="
        echo "查找APK文件..."
        echo "=========================================="
        echo "1. 检查 bin/ 目录（Buildozer 默认输出）："
        if [ -d "bin" ]; then
          ls -la bin/ || true
          APK_FILES=$(find bin -name "*.apk" -type f 2>/dev/null)
          if [ -n "$APK_FILES" ]; then
            echo "找到 APK 文件："
            echo "$APK_FILES"
          else
            echo "bin/ 目录中没有找到 APK 文件"
          fi
        else
          echo "bin/ 目录不存在"
        fi
        echo ""
        echo "2. 检查 dist/ 目录："
        if [ -d "dist" ]; then
          ls -la dist/ || true
          APK_FILES=$(find dist -name "*.apk" -type f 2>/dev/null)
          if [ -n "$APK_FILES" ]; then
            echo "找到 APK 文件："
            echo "$APK_FILES"
          else
            echo "dist/ 目录中没有找到 APK 文件"
          fi
        else
          echo "dist/ 目录不存在"
        fi
        echo ""
        echo "3. 检查 .buildozer 目录："
        if [ -d ".buildozer" ]; then
          APK_FILES=$(find .buildozer -name "*.apk" -type f 2>/dev/null)
          if [ -n "$APK_FILES" ]; then
            echo "找到 APK 文件："
            echo "$APK_FILES"
          else
            echo ".buildozer 目录中没有找到 APK 文件"
          fi
        else
          echo ".buildozer 目录不存在"
        fi
        echo ""
        echo "4. 在整个工作区查找所有 APK 文件："
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null | head -20)
        if [ -n "$APK_FILES" ]; then
          echo "找到 APK 文件："
          echo "$APK_FILES"
        else
          echo "工作区中没有找到 APK 文件"
        fi
        echo ""
        echo "5. 检查构建日志中的 APK 信息："
        if [ -f "build.log" ]; then
          grep -i "apk\|build successful\|BUILD SUCCESSFUL\|package.*apk" build.log | tail -20 || true
        fi
        echo "=========================================="
      
    - name: 复制APK到dist目录
      run: |
        echo "=========================================="
        echo "查找并复制 APK 文件到 dist/ 和 bin/ 目录"
        echo "=========================================="
        mkdir -p dist
        mkdir -p bin
        echo "1. 在整个工作区查找所有 APK 文件..."
        ALL_APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null)
        if [ -n "$ALL_APK_FILES" ]; then
          echo "找到以下 APK 文件："
          echo "$ALL_APK_FILES"
          echo ""
          echo "复制所有 APK 文件到 dist/ 和 bin/ 目录..."
          for apk in $ALL_APK_FILES; do
            if [ -f "$apk" ]; then
              echo "复制: $apk -> dist/"
              cp "$apk" dist/ || true
              echo "复制: $apk -> bin/"
              cp "$apk" bin/ || true
            fi
          done
        else
          echo "未找到任何 APK 文件"
          echo ""
          echo "检查构建日志中的关键信息..."
          if [ -f "build.log" ]; then
            echo "构建日志最后 50 行："
            tail -50 build.log
            echo ""
            echo "查找日志中的 'apk' 关键词："
            grep -i "apk\|build.*success\|BUILD.*SUCCESS" build.log | tail -20 || true
          fi
        fi
        echo ""
        echo "2. 检查 dist/ 目录内容："
        if [ -d "dist" ]; then
          ls -lah dist/ || true
          DIST_APK_COUNT=$(find dist -name "*.apk" -type f 2>/dev/null | wc -l)
          if [ "$DIST_APK_COUNT" -gt 0 ]; then
            echo "✅ dist/ 目录中有 $DIST_APK_COUNT 个 APK 文件"
            find dist -name "*.apk" -type f -exec ls -lh {} \;
          else
            echo "❌ dist/ 目录中没有 APK 文件"
          fi
        fi
        echo ""
        echo "3. 检查 bin/ 目录内容："
        if [ -d "bin" ]; then
          ls -lah bin/ || true
          BIN_APK_COUNT=$(find bin -name "*.apk" -type f 2>/dev/null | wc -l)
          if [ "$BIN_APK_COUNT" -gt 0 ]; then
            echo "✅ bin/ 目录中有 $BIN_APK_COUNT 个 APK 文件"
            find bin -name "*.apk" -type f -exec ls -lh {} \;
          else
            echo "❌ bin/ 目录中没有 APK 文件"
          fi
        fi
        echo "=========================================="
      
    - name: 上传构建日志
      uses: actions/upload-artifact@v4
      if: failure()
      continue-on-error: true
      with:
        name: build-logs
        path: logs/*.log
        retention-days: 7
        if-no-files-found: ignore
      
    - name: 上传APK
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true
      with:
        name: android-apk
        path: |
          dist/*.apk
          bin/*.apk
        retention-days: 30
        if-no-files-found: warn
