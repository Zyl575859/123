name: 构建Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-11-jdk python3-pip build-essential autoconf automake libtool libtool-bin pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev python3-dev
        
    - name: 安装Buildozer和依赖
      run: |
        pip3 install --user buildozer cython
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: 初始化Android SDK环境
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $ANDROID_HOME/licenses
        
    - name: 手动安装Android SDK Command-line Tools
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $ANDROID_HOME/cmdline-tools
        
        # 下载并安装 command-line tools
        cd /tmp
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip || wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-*.zip -d $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest || true
        
        # 创建 buildozer 期望的旧路径（符号链接）
        mkdir -p $ANDROID_HOME/tools/bin
        if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
          ln -sf $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager $ANDROID_HOME/tools/bin/sdkmanager || true
        fi
        
    - name: 接受Android SDK许可证
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
        
        # 创建许可证文件
        mkdir -p $ANDROID_HOME/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
        
        # 使用 sdkmanager 接受所有许可证
        if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        fi
        
    - name: 构建APK
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export ANDROID_NDK=$HOME/.buildozer/android/platform/android-ndk-r25b
        export PATH=$PATH:$ANDROID_HOME/tools/bin:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin
        # 设置环境变量以确保构建工具可以找到所有依赖
        export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/lib/pkgconfig
        # 运行构建，保存完整日志
        echo "开始构建 APK..."
        buildozer android debug 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "=========================================="
          echo "构建失败，查看详细日志："
          echo "=========================================="
          tail -100 build.log
          exit 1
        fi
        echo "构建命令执行完成，退出代码: $BUILD_EXIT_CODE"
        
    - name: 查找APK文件
      run: |
        echo "=========================================="
        echo "查找APK文件..."
        echo "=========================================="
        # 检查 bin/ 目录
        echo "1. 检查 bin/ 目录："
        if [ -d "bin" ]; then
          ls -la bin/ || true
          APK_FILES=$(find bin -name "*.apk" -type f 2>/dev/null)
          if [ -n "$APK_FILES" ]; then
            echo "找到 APK 文件："
            echo "$APK_FILES"
          else
            echo "bin/ 目录中没有找到 APK 文件"
          fi
        else
          echo "bin/ 目录不存在"
        fi
        echo ""
        # 检查 .buildozer 目录
        echo "2. 检查 .buildozer 目录："
        if [ -d ".buildozer" ]; then
          APK_FILES=$(find .buildozer -name "*.apk" -type f 2>/dev/null)
          if [ -n "$APK_FILES" ]; then
            echo "找到 APK 文件："
            echo "$APK_FILES"
          else
            echo ".buildozer 目录中没有找到 APK 文件"
          fi
        else
          echo ".buildozer 目录不存在"
        fi
        echo ""
        # 查找所有 APK 文件
        echo "3. 在整个工作区查找所有 APK 文件："
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null | grep -v ".buildozer" | head -20)
        if [ -n "$APK_FILES" ]; then
          echo "找到 APK 文件："
          echo "$APK_FILES"
        else
          echo "工作区中没有找到 APK 文件"
        fi
        echo ""
        # 检查构建日志中的信息
        echo "4. 检查构建日志中的 APK 信息："
        if [ -f "build.log" ]; then
          grep -i "apk\|build successful\|BUILD SUCCESSFUL" build.log | tail -10 || true
        fi
        echo "=========================================="
      
    - name: 复制APK到bin目录
      run: |
        echo "=========================================="
        echo "查找并复制 APK 文件到 bin/ 目录"
        echo "=========================================="
        mkdir -p bin
        
        # 方法1: 查找所有 APK 文件
        echo "1. 在整个工作区查找所有 APK 文件..."
        ALL_APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null)
        
        if [ -n "$ALL_APK_FILES" ]; then
          echo "找到以下 APK 文件："
          echo "$ALL_APK_FILES"
          echo ""
          echo "复制所有 APK 文件到 bin/ 目录..."
          for apk in $ALL_APK_FILES; do
            if [ -f "$apk" ]; then
              echo "复制: $apk -> bin/"
              cp "$apk" bin/ || true
            fi
          done
        else
          echo "未找到任何 APK 文件"
          echo ""
          echo "检查构建日志中的关键信息..."
          if [ -f "build.log" ]; then
            echo "构建日志最后 50 行："
            tail -50 build.log
            echo ""
            echo "查找日志中的 'apk' 关键词："
            grep -i "apk\|build.*success\|BUILD.*SUCCESS" build.log | tail -20 || true
          fi
        fi
        
        echo ""
        echo "2. 检查 bin/ 目录内容："
        if [ -d "bin" ]; then
          ls -lah bin/ || true
          BIN_APK_COUNT=$(find bin -name "*.apk" -type f 2>/dev/null | wc -l)
          if [ "$BIN_APK_COUNT" -gt 0 ]; then
            echo "✅ bin/ 目录中有 $BIN_APK_COUNT 个 APK 文件"
            find bin -name "*.apk" -type f -exec ls -lh {} \;
          else
            echo "❌ bin/ 目录中没有 APK 文件"
          fi
        fi
        echo "=========================================="
      
    - name: 上传APK
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 30
        if-no-files-found: warn
